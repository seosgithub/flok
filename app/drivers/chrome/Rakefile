require 'fileutils'
require 'flok/build'
require 'securerandom'
require 'tmpdir'
require 'phantomjs'
require 'tempfile'

#Compile all the *.js files into one file
task :build do
  raise "No BUILD_PATH given" unless build_path=ENV["BUILD_PATH"]
  build_path = File.expand_path(build_path)

  my_path = File.expand_path(File.dirname(__FILE__))
  Dir.mktmpdir(SecureRandom.hex) do |dir|
    Dir.chdir dir do
      Flok.src_glob("js", "#{my_path}/src/vendor", "0src_vendor.js")
      Flok.src_glob("js", "#{my_path}/src/", "1src.js")
      Flok.src_glob("js", ".", File.join(build_path, "chrome.js"))
    end
  end
end

#Make sure it runs
task :spec do
  Dir.chdir "../../../products/chrome/drivers"
  `phantomjs chrome.js`
end

#Establish an environment with a pipe assuming the world is built
#Should return the input pipe file location when exiting to stdout and
#return the PID of the process 2nd seperated by a space.
#Like "/tmp/30p043.pipe 3020" which is "stdin_pipe pid"
#and should not write anything to stdout other than this
#SHOULD NOT LOAD application.js, just the driver necessities and this
task :pipe do
  system("rake build BUILD_PATH='../../../products/chrome/drivers'")

  #Go into the correct directory
  Dir.chdir "../../../products/chrome"

  #Dump both application.js and chrome.js into one file for phantomjs
  tmp = Tempfile.new(SecureRandom.hex)
  tmp.puts File.read("./drivers/chrome.js")
  tmp.close

  timeout = ENV['TIMEOUT']
  if timeout
    system("boojs -t #{timeout} #{tmp.path}")
  else
    system("boojs #{tmp.path}")
  end
end
